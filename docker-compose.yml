version: '3'
services:
    web:
        build: ./Backend
        restart: always
        working_dir: /dir
        volumes:
            - ./Backend:/dir
        environment:
            - FLASK_APP=app
            - FLASK_ENV=development
        ports:
            - "800:5000"
            - "443:443"
        depends_on:
            - mongo
        
        command: python -m flask run --host=0.0.0.0 
               
    mongo:
        image: mongo
        restart: always              
        ports:
            - "27017:27017"
        volumes:
            - ./db_backup:/db_backup   
            - ./Database:/data/db
    
    theia:
        image: theiaide/theia-python
        ports:
           - "3001:3000"
        volumes:
           - ./:/home/project
    
    mongoide:
        image: mongo-express
        volumes:
            - ./db_backup:/db_backup
        ports:
            - "8081:8081"
        links:
            - mongo
        environment:           
            - ME_CONFIG_OPTIONS_EDITORTHEME="ambiance"
            - ME_CONFIG_MONGODB_SERVER=mongo 
    nodered:
        image: nodered/node-red-docker
        volumes:
            - ./nodered:/data
        ports:
            - "1880:1880"
        links:
            - mongo
            - web
            - mqtt
    mqtt:
        image: eclipse-mosquitto
        ports:
            - "1883:1883"
            - "9001:9001"
        volumes:
                - ./mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf
                - ./mqtt/logs:/mosquitto/log
                - ./mqtt/data:/mosquitto/data
    nginx:
        image: nginx:1.13
        volumes:
        - "./app:/var/www/html"
        - "./nginx/nginx.conf:/etc/nginx/nginx.conf"
        ports:
        - "80:80"
        depends_on:
        - php

    # Application service layer
    php:
        build:
        context: ./php
        volumes:
        - "./app:/var/www/html"
        ports:
        - "9000:9000"
        depends_on:
        - mysql
        environment:
        - MYSQL_USER=root
        - MYSQL_PASS=123.456
    
    # Data persistence service layer
    mysql:
        image: mysql:5.7.20
        volumes:
        - "db_data:/var/lib/mysql"
        - "./mysql/initial_data:/docker-entrypoint-initdb.d"
        ports:
        - "3306:3306"
        environment:
        - MYSQL_ROOT_PASSWORD=123.456
    phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        links:
        - mysql
        ports:
        - 801:80
        environment:
        - PMA_HOST=mysql

         

 